---
name: Нужно написать простую библиотеку in-memory cache
module: Практика
tags:
  - грейды
---

Нужно написать простую библиотеку in-memory cache.
Для простоты считаем, что у нас бесконечная память и нам не нужно задумываться об удалении ключей из него.
Реализация должна удовлетворять интерфейсу:
https://matrix.o3.ru/trials

```go
package main

type Cache interface {
    Set(k, v string)
    Get(k string) (v string, ok bool)
}
```

**18 грейд**

Решил в лоб с sync. RW Mutex'ом, без применения шардирования, правильно инициализировал map в конструкторе.
Может подсветить проблемы в использовании: переполнение памяти, дублирование памяти из-за нескольких процессов, нету механизма для инвалидации кеша (ключи будут жизни вечно),

**19 грейд**

Рассказал про различие sync.Mutex + sync.RWMutex. Решил с шардированием и рассказал про алгоритмы хеширования и смог либо написать свою реализацию, либо вызов из std lib.
Предложил решение проблем, описанных в 18 грейде.
Может рассказать про плюсы/минусы такого решения в сравнении с, например, memcached.

**20 грейд**

Может порассуждать на темы:

- нужно ли кешировать ответы с ошибками или отсутствие данных
- что лучше: LRU или TTL?
- когда нужно использовать централизованное кеширование или распределенное
- есть ли смысл в кеше, который не помещается в память и частично сохраняется на диск

Дополнительные вопросы
Q: Если кандидат написал map + sync.Mutex, то спросить можно ли найти решение лучше?

Q: Если для решения использовался sync.RWMutex, то спросить в каких случаях это будет работать медленно?
A: При большом количестве запросов lock contention будет расти и любая запись будет тормозить чтение.

Q: Как это можно решить?
A: Шардировать данные, попросить написать решение с учетом шардинга

Q: Как шардировать данные?
A: Ожидается ответ про алгоритмы хеширования (md5, crc и т.д.)

Q: Сколько шардов нужно делать?
A: Не меньше, чем кол-во потоков, а лучше больше и кратно этому значению.

Q: Можно ли сделать еще более быстрый кеш, если у нас мало ключей и мы заранее знаем, что они идут от "1" до "10000" и других ключей не бывает?
A: Можно использовать слайс, заранее выделенного размера.