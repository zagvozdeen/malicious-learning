---
name: Что выведет код ниже (задача на горутины в цикле)?
module: Практика
tags:
  - avito
  - easy
---

2 варианта вопроса:

- Что выведет следующая программа и почему?
- Можно попросить кандидата "провести code-review коллеги и найти проблемы, если есть". Саму логику того, что это через горутины не меняем.

```go
// Находим максимальное четное число
package main

import "fmt"

func main() {
	var max int
	for i := 1000; i > 0; i-- {
		go func() {
			if i%2 == 0 && i > max {
				max = i
			}
		}()
	}
	fmt.Printf("Maximum is %d", max)
}
```

Что проверяем:

- Базовое знание горутин
- Понимание областей видимости переменных
- Знание примитивов синхронизации
- Понимание проблем race conditions

||**Проблема 1: замыкание.** Вывод не соответствует тому, что мы ожидаем - так как замыкание i в цикле связывает значение переменной (и на это ругнётся `go vet` при сборке - `./prog.go:10:25: loop variable i captured by func literal`). Каким будет i в момент запуска первой горутины мы не знаем. В Go 1.22 и выше проблема неактуальна. Решение: передать i как параметр в анонимную функцию.||

||**Проблема 2: синхронизация.** Программа завершается не обязательно дождавшись присвоения хотя бы одного числа (запуска хотя бы одной горутины). Решение: синхронизировать ожидание через `sync.WaitGroup`. Дополнительный вопрос к секции: если кандидат использует defer для `wg.Done()` спросить осознанность его решения и почему он не написал линейно без `defer`. Можно уточнить тут про потенциальную дополнительную нагрузку, которую дает (или не дает `defer`). Поговорить про Low-cost defers

||**Проблема 3: race conditions.** Переменная max будет использоваться множеством горутин, вызывая race condition. Значение переменной в итоге может получиться любым. Решение: можно решить разными путями, но базово - через Mutex. Важная ремарка - если править через Атомики только строчку присвоения - проблема не решится. Лочить обязательно необходимо также и строку со сравнением. Дополнительно: тут важно понять насколько кандидат вообще понимает принципы concurrency в ходе его рассуждений о решении. Если он сразу поставит лок перед условием - спросить "зачем мы лочим вообще все, если читать можно конкурентно без проблем".||

Дополнительные вопросы:

Какие есть инструменты (и есть ли) в go, которые могут помочь найти проблемы выше? ||Ответ: `go vet`, `-race` флаг.||