---
name: Вопрос о медленном сервисе
module: Архитектура
tags:
  - грейды
  - озон
---
На примере создания заказа. Есть запрос на сервис и есть ответ, между этими двумя
действиями мы сладываем в аналитику товары которые заказали (например для подсчета
популярности товаров). Сервис аналитики переодически работает медленно или вовсе
таймаутит, и мы не успеваем ответить, теряем заказы.

﻿Что делать, что бы перестать терять заказы, и деньги соответсвенно?

```
+------+      +----------------+      +--------------------+
| User |      |  OrderService  |      |  AnalyticsService  |
+------+      +----------------+      +--------------------+
   |                   |                        |
   |    CreateOrder    |                        |
   |------------------>|       TrackOrder       |
   |                   |----------------------->|  Too long action
   |                   |                        |------------------>|
   |                   |                        |<------------------|
   |                   |<-----------------------| 
   |<------------------|                        |
   |                   |                        |
```

Придумать как распаралелить заказ и аналитику.

**Дополнительные вопросы**

Q: (Если решение через БД) Как организовать воркеры, так, что бы они не брали в работу
одни и те же данные?
A: Придумать как не заселектить в несколько воркеров одинаковые
данные для обработки, например мастер процесс который будет раздавать задачи.

Q: Сервис аналитики не будет читать данные из нас или нашей очереди, что будем
делать?
A: Придумать способ как самим пушить данные в аналитику из своей очереди

Q: Отдел аналитики жалуется на высокий RPS от нас когда они под нагрузкой мы их сервис
кладем. Как решить проблему?
A: Просто уменьшить рпс в конфигах плохая идея тогда
будет копиться очередь. Нужно придумать экспоненциальное повышение или понижение
нагрузки в зависимости от состояния аналитики

Q: Проблема с аналитикой решена. Теперь проблема с местом занимаемым нашей
очередю, инфра ограничила ресурсы(расширять дальше некуда), что делать? (На
аналитику повлиять мы не можем, у них в планах переписать сервис и тд нужно свое
решение.)
A: Надо придумать как мы будем просеивать данные в зависимости от нашей
квоты на ресурсы и загруженности очередей. Например вытеснением или прореживанием
данных для аналатики на входе нашего сервиса.