---
name: Задача на РСУБД
module: Базы данных
tags:
  - грейды
  - озон
---
Есть 3 сущности: пользователь, чат, сообщение.

- У пользователя есть имя и дата регистрации
- У чата есть название и дата создания
- У сообщения есть текст, автор и дата создания
- Пользователь может состоять в нескольких чатах одновременно Сообщение обязательно принадлежит чату, сообщение не может принадлежать более чем 1 чату одновременно
- Нужно описать предметную область в виде таблиц

**17 грейд**

```sql
create table users  
(  
    id         int primary key,  
    name       text      not null,  
    created_at timestamp not null  
);  
  
create table chats  
(  
    id         int primary key,  
    name       text      not null,  
    created_at timestamp not null  
);  
  
create table messages  
(  
    id         int primary key,  
    content    text      not null,  
    author_id  int       not null,  
    chat_id    int       not null,  
    created_at timestamp not null  
);  
  
create table user_chats  
(  
    user_id int,  
    chat_id int,  
    primary key (user_id, chat_id)  
);
```

**Дополнительные вопросы**

Выбрать все чаты пользователя Вася в формате (`chat_id`, `chat_name`).

```sql
select uc.chat_id, c.name chat_name
from users u
join user_chats uc on uc.user_id = u.id
join chats c on c.id = uc.chat_id
where u.name = 'Вася'
```

- Какие еще виды соединений кроме join знаешь?

Достаточно ответить про left join, right join

- Что будет, если вместо join применить left join в этом запросе?

Ничего не изменится

**18 грейд**

Включает ответы на 17 грейд, задаем больше дополнительных вопросы.

1. Что такое индекс? Сколько и какие индексы будут созданы по этой схеме?
2. По мере роста размеров таблиц этот запрос начинает все медленнее работать, можешь понять почему и исправить?
3. (Не спрашивать, если кандидат не знает про explain) Что показывает эта команда?
4. (Не спрашивать, если кандидат не знает про explain) Какой узел плана однозначано показывает, что не хватает индекса?
5. Как заполнять поле id при вставках в таблицы users, chats, messages

Ответы:

1. Индекс - это вспомогательная структура данных для ускорения доступа к таблице, неявно управляется ядром БД. 4 - для каждой таблицы для полей с указанием primary key будет создан уникальный B-TREE индекс.
2. Добавить индекс на user(name), в более сложных случаях профилировать запрос с помощью `EXPLAIN [ANALYZE]`.
3. План запроса с оценкой сложности по узлам
4. SeqScan
5. Перейти на автоинкрементное поле (`id serial primary key`). Или перейти на генерацию uuid на стороне приложения.

**19 грейд**

Включает ответы на 18 грейд, задаем больше дополнительных вопросы

Дополнительные вопросы:

1. Чаты становятся популярными, число пользователей растет и нам скоро не хватит свободного места на диске для хранения всей переписки. Что нам делать?
2. Какой первичный ключ лучше - числовой или uuid?

Ответы:

1. Нужно шардировать. Шардируем наиболее сильно растущие данные - в данном примере это таблица messages, потому что хранит генерируемый пользователем текст.
2. Ответа нет.