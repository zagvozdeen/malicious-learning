---
name: Ожидание завершения горутин
module: Практика
tags:
  - грейды
  - озон
---
Что выведет на экран эта программа?

```go
package main

import "fmt"

func main() {
	for i := 0; i < 5; i++ {
		go func() {
			fmt.Println(i)
		}()
	}
}
```

**17 грейд**

Поведение не определено - скорее всего ничего не будет выведено на экран поскольку программа завершится не дождавшись горутин. Также в программе есть вторая проблема - даже если дождаться всех горутин на экран скорее всего будет выведено одно и то же число поскольку все горутины используют одну и ту же переменную i (исправлено в go 1.22 и выше)

**18 грейд**

- Знает, что с go 1.22 проблема переменной уже не актуальна.
- Решил через sync.WaitGroup
- Предпочтительны решения с использованием defer

**Дополнительные вопросы**

Q: Как можно было бы изменить программу, чтобы дожидаться всех созданных горутин?
A: Например можно использовать sync.WaitGroup:

```go
package main

import (
	"fmt"
	"sync"
)

func main() {
	wg := sync.WaitGroup{}
	for i := 0; i < 5; i++ {
		wg.Add(1)
		go func() {
			defer wg.Done()
			fmt.Println(i)
		}()
	}
	wg.Wait()
}
```

Q: Как можно было бы изменить программу чтобы каждая горутина правильно выводила свой индекс?
A: Требуется использовать из горутины локальную копию i или явно передавать i в горутину как аргумент:

```go
package main

import (
	"fmt"
	"sync"
)

func main() {
	var wg sync.WaitGroup
	for i := 0; i < 5; i++ {
		wg.Add(1)
		go func(k int) {
			defer wg.Done()
			fmt.Println(k)
		}(i)
	}
	wg.Wait()
}

```